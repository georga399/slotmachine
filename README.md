# Программа Slotmachine на Solana

Децентрализованная игровая программа "однорукий бандит", построенная на блокчейне Solana с использованием фреймворка Anchor.

## Обзор программы

Программа Slotmachine позволяет пользователям играть в азартную игру, где они могут крутить барабаны и потенциально выиграть награды в SOL. Программа включает:

- **Система хранилищ**: Централизованная казна для игровых наград
- **Пользовательские хранилища**: Индивидуальные счета игроков для хранения выигрышей
- **Рандомизированные результаты**: Псевдо-случайные результаты вращений на основе алгоритма с seed
- **Выводимые выигрыши**: Игроки могут выводить свои накопленные награды

## ID программы

**Devnet**: `HpKZfyCptLBsFKtxFQiyWHNCpBmpWKERvZXY8YrSnLD4`

## Ключевые адреса

- **Казна**: `99HiteJ3VVqrsNXdu2TJv7H9E76YFACgQrSwfhi9cLWT`
- **Размер ставки**: 0.1 SOL за вращение

## Функции программы

### `init()`
Инициализирует основное PDA хранилище казны.
- **Seeds**: `["treasury"]`
- **Авторизация**: Любой подписант
- **Создает**: Аккаунт хранилища с начальным значением seed

### `create_user_vault()`
Создает специфичное для пользователя PDA хранилище для хранения выигрышей.
- **Seeds**: `["uvault", user_public_key]`
- **Авторизация**: Подписант пользователя
- **Цель**: Хранить выигрыши игроков отдельно от основной казны

### `spin()`
Выполняет вращение игрового автомата.
- **Размер ставки**: 0.1 SOL (переводится в хранилище казны)
- **Вероятность выигрыша**:
  - Мега-выигрыш (10% шанс): 2x размер ставки (0.2 SOL)
  - Большой выигрыш (10% шанс): 1x размер ставки (0.1 SOL)
  - Малый выигрыш (40% шанс): 0.5x размер ставки (0.05 SOL)
  - Проигрыш (40% шанс): Нет награды
- **Рандомизация**: Использует XOR-shift алгоритм с seed хранилища
- **Авто-создание**: Пользовательское хранилище, если оно не существует

### `claim_winnings()`
Выводит накопленные выигрыши из пользовательского хранилища на кошелек.
- **Оставляет**: Минимальную сумму для освобождения от ренты (0.00096744 SOL) в пользовательском хранилище
- **Авторизация**: Только подписант пользователя

### `withdraw_from_vault(amount)`
Административная функция для вывода средств из хранилища казны.
- **Авторизация**: Любой подписант (в настоящее время без ограничений)
- **Проверки**: Гарантирует сохранение минимальной суммы для освобождения от ренты
- **Цель**: Управление казной

## Игровая механика

### Алгоритм вращения
```rust
// XOR-shift рандомизация
seed ^= seed >> 12;
seed ^= seed << 25;
seed ^= seed >> 27;
seed = seed.wrapping_mul(0x2545F4914F6CDD1D);

// Определение выигрыша (диапазон 0-19)
let win_decider = seed % 20;
```

### Условия выигрыша
- `win_decider > 17` (18-19): Мега-выигрыш - 2x ставка
- `win_decider > 14` (15-17): Большой выигрыш - 1x ставка
- `win_decider > 8` (9-14): Малый выигрыш - 0.5x ставка
- `win_decider ≤ 8` (0-8): Проигрыш

## Скрипты

### Bash скрипты

#### `scripts/add-to-vault.sh`
Добавляет SOL в казну для финансирования игры.

**Использование:**
```bash
./scripts/add-to-vault.sh <количество_SOL>
```

**Пример:**
```bash
./scripts/add-to-vault.sh 1
```

**Что делает:**
- Переводит указанное количество SOL на адрес хранилища
- Показывает баланс хранилища после перевода

#### `scripts/withdraw-from-vault.sh`
Выводит определенное количество средств из казны на ваш кошелек.

**Использование:**
```bash
./scripts/withdraw-from-vault.sh <количество_SOL>
```

**Пример:**
```bash
./scripts/withdraw-from-vault.sh 0.5
```

**Что делает:**
- Вызывает TypeScript скрипт вывода
- Показывает баланс хранилища после вывода
- Хранилище сохраняет минимальный баланс для освобождения от ренты

### TypeScript скрипты (через npm)

#### `npm run spin`
Выполняет вращение игрового автомата.

**Использование:**
```bash
npm run spin
```

**Требования:**
- Настроенный кошелек Solana CLI по пути `~/.config/solana/id.json`
- Минимум 0.1 SOL + комиссии за транзакции на кошельке

**Что делает:**
- Делает ставку 0.1 SOL
- Автоматически создает пользовательское хранилище при необходимости
- Показывает результаты вращения и выигрыши
- Отображает ссылку на транзакцию в Solana Explorer

#### `npm run claim`
Выводит накопленные выигрыши из вашего пользовательского хранилища.

**Использование:**
```bash
npm run claim
```

**Требования:**
- Настроенный кошелек Solana CLI по пути `~/.config/solana/id.json`
- Доступные выигрыши в пользовательском хранилище

**Что делает:**
- Выводит все доступные для вывода выигрыши (сохраняет минимальную сумму для ренты)
- Переводит SOL на ваш кошелек
- Показывает сумму вывода и детали транзакции

#### `npm run withdraw`
Выводит определенное количество средств из казны на ваш кошелек.

**Использование:**
```bash
npm run withdraw <количество_SOL>
```

**Пример:**
```bash
npm run withdraw 0.5
```

**Требования:**
- Настроенный кошелек Solana CLI по пути `~/.config/solana/id.json`
- В казне должно быть достаточно средств (исключая минимальную сумму для ренты)
- Сумма должна быть больше 0

**Что делает:**
- Выводит указанное количество SOL из казны
- Хранилище сохраняет минимальный баланс для освобождения от ренты (~0.000967 SOL)
- Показывает балансы до/после и детали транзакции
- Проверяет достаточность средств перед выводом

## Тестирование

Запустите набор тестов для проверки функциональности программы:

```bash
npm test
```

Тестовые сценарии включают:
- Инициализация хранилища
- Создание пользовательского хранилища
- Механику вращений и исходы выигрыш/проигрыш
- Вывод выигрышей
- Административные выводы из хранилища

## Разработка

### Предварительные требования
- Node.js
- Yarn
- Rust
- Solana CLI
- Anchor framework

### Установка
```bash
yarn install
```

### Сборка
```bash
anchor build
```

### Деплой
```bash
anchor deploy
```

### Тестирование
```bash
anchor test
```

## Архитектура

### Аккаунты
- **Vault**: Хранит состояние игры (счетчик вращений, случайный seed)
- **UserVault**: Хранилище индивидуальных выигрышей игроков

### PDA (Program Derived Addresses)
- Казна: `findProgramAddress(["treasury"], programId)`
- Пользовательское хранилище: `findProgramAddress(["uvault", userPubkey], programId)`

### Константы
- `BET_AMOUNT`: 100,000,000 лампортов (0.1 SOL)
- `RENT`: 967,440 лампортов (минимальная сумма для освобождения от ренты)

## Соображения безопасности

⚠️ **Важно**: Текущая реализация имеет неограниченный доступ к функции `withdraw_from_vault`. В продакшене это должно быть ограничено авторизованными администраторами.

## Лицензия

ISC
